<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Интеллектуальный генератор микроразметки со Schema.org</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <!-- Подключение основного CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <!-- Socket.IO клиент -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
<div class="container">
  <h1 class="text-center mb-4"><i class="bi bi-code-square schema-icon"></i>iSEO Schema Generator</h1>
  
  <div class="schema-info">
    <p>Внутренний инструмент для SEO-специалистов, генерирующий микроразметку Schema.org на основе анализа сайта. <strong>AI с функцией веб-поиска создаёт персонализированную микроразметку, основанную на реальном содержимом.</strong></p>
    <div class="alert alert-info">
      <i class="bi bi-lightbulb-fill me-2"></i>
      <strong>Pro tip:</strong> Для более точных результатов используйте URL страницы, соответствующей типу микроразметки (например, URL товара для Product).
    </div>
  </div>
  
  <ul class="nav nav-tabs" id="schemaTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single-schema" type="button" role="tab" aria-controls="single-schema" aria-selected="true">Единичная генерация</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-schemas" type="button" role="tab" aria-controls="all-schemas" aria-selected="false">Полный комплект</button>
    </li>
  </ul>
  
  <div class="tab-content" id="schemaTabContent">
    <!-- Вкладка с одиночным шаблоном -->
    <div class="tab-pane fade show active" id="single-schema" role="tabpanel" aria-labelledby="single-tab">
      <form id="templateForm">
        <div class="form-floating mb-3">
          <select class="form-select" id="element_type" name="element_type">
            {% for key, value in element_types.items() %}
              <option value="{{ key }}">{{ value }}</option>
            {% endfor %}
          </select>
          <label for="element_type">Тип элемента</label>
        </div>
        <div class="form-floating mb-3">
          <input type="url" class="form-control" id="url" name="url" placeholder="https://example.com" required>
          <label for="url">URL сайта</label>
          <div class="form-text">Введите полный URL с https:// или http:// страницы, для которой нужна микроразметка</div>
        </div>
        <div class="d-grid">
          <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
            <i class="bi bi-code-square me-2"></i> Сгенерировать микроразметку
          </button>
        </div>
      </form>
      
      <div class="alert alert-danger mt-3" id="errorBlock" style="display:none;"></div>
      
      <!-- Блок статуса генерации -->
      <div class="status-container" id="statusContainer" style="display:none;">
        <div class="card mt-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-hourglass-split me-2"></i>Статус генерации
            </h5>
            <span class="badge bg-primary" id="statusBadge">Ожидание</span>
          </div>
          <div class="card-body">
            <div class="status-message" id="statusMessage">Подготовка к анализу сайта...</div>
            
            <div class="progress mt-3">
              <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" 
                   role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
            </div>
            
            <div class="d-flex justify-content-between mt-2">
              <small id="elapsedTime">Прошло: 0 сек</small>
              <small id="estimatedTime">Примерное время: 20-30 сек</small>
            </div>
            
            <div class="generation-steps mt-3">
              <div class="step" id="step1">
                <i class="bi bi-1-circle me-2"></i>
                <span>Анализ структуры сайта</span>
                <small class="status-indicator">ожидание</small>
              </div>
              <div class="step" id="step2">
                <i class="bi bi-2-circle me-2"></i>
                <span>Извлечение данных со страницы</span>
                <small class="status-indicator">ожидание</small>
              </div>
              <div class="step" id="step3">
                <i class="bi bi-3-circle me-2"></i>
                <span>Создание микроразметки</span>
                <small class="status-indicator">ожидание</small>
              </div>
              <div class="step" id="step4">
                <i class="bi bi-4-circle me-2"></i>
                <span>Оптимизация и валидация</span>
                <small class="status-indicator">ожидание</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="loading-spinner" id="spinner" style="display:none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Загрузка...</span>
        </div>
        <p class="mt-2">AI анализирует ваш сайт в режиме реального времени...</p>
        <p class="text-muted small">Это может занять до 30 секунд, в зависимости от объёма данных на сайте</p>
      </div>
      
      <div class="mt-4" id="resultContainer" style="display:none;">
        <div class="result-header">
          <h3>Результат:</h3>
          <button id="copyBtn" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-clipboard"></i> Копировать
          </button>
        </div>
        <pre id="resultBlock" class="p-3 bg-light border rounded"></pre>
        
        <!-- Добавляем блок предпросмотра для единичной генерации -->
        <div class="snippet-preview my-3 p-3 border rounded">
          <h6 class="snippet-preview-title mb-3">
            <i class="bi bi-eye me-2"></i>Предпросмотр Rich Snippets:
            <span class="badge bg-info ms-2">Google</span>
          </h6>
          <div class="snippet-container p-3 border rounded bg-white" id="singleSnippet">
            <!-- Здесь будет отображаться предпросмотр сниппета -->
            <div class="google-snippet-placeholder text-center py-3">
              <i class="bi bi-hourglass-split text-muted me-2"></i>
              <span class="text-muted">Сниппет будет отображен после генерации</span>
            </div>
          </div>
          <div class="snippet-notice text-center text-muted small mt-2">
            <i class="bi bi-info-circle me-1"></i>Это приблизительный вид сниппета. Фактическое отображение может отличаться.
          </div>
        </div>
      </div>
    </div>
    
    <!-- Вкладка со всеми шаблонами -->
    <div class="tab-pane fade" id="all-schemas" role="tabpanel" aria-labelledby="all-tab">
      <form action="/results" method="post">
        <div class="form-floating mb-3">
          <input type="url" class="form-control" id="allUrl" name="url" placeholder="https://example.com" required>
          <label for="allUrl">URL сайта</label>
          <div class="form-text">Введите полный URL с https:// или http:// главной страницы сайта для анализа</div>
        </div>
        <div class="alert alert-warning mb-3">
          <i class="bi bi-info-circle-fill me-2"></i>
          Генерация всех типов микроразметки займет около 2-3 минут
        </div>
        <div class="d-grid">
          <button type="submit" class="btn btn-success btn-lg btn-generate-all">
            <i class="bi bi-code-square me-2"></i> Сгенерировать полный комплект
          </button>
        </div>
      </form>
      
      <!-- Блок с прогрессом генерации всех шаблонов -->
      <div class="card mt-4" id="allProgressCard" style="display:none;">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Прогресс генерации</h5>
        </div>
        <div class="card-body">
          <div class="progress mb-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" id="allProgressBar" 
                 role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
          </div>
          
          <div id="allProgressStats" class="text-center mb-3">
            <span id="completedCount">0</span> из <span id="totalTypes">{{ element_types|length }}</span> шаблонов
          </div>
          
          <div class="current-task" id="currentTask">
            Ожидание начала генерации...
          </div>
          
          <div class="completed-tasks mt-3" id="completedTasks">
            <h6>Завершенные шаблоны:</h6>
            <ul class="list-group" id="completedList">
              <!-- Сюда будут добавляться завершенные задачи -->
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="text-center mt-4">
    <small class="text-muted">
      iSEO Schema Generator — внутренний инструмент для SEO-специалистов
    </small>
  </div>
  
  <div class="features-section mt-5 mb-3">
    <h4 class="text-center mb-4">Преимущества для SEO-специалистов</h4>
    <div class="row g-4">
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-search text-primary me-2"></i>Точность данных</h5>
            <p class="card-text">Автоматический анализ сайта извлекает реальные данные: названия, цены, адреса и другую информацию без необходимости ручного ввода.</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-lightning-charge text-primary me-2"></i>Скорость работы</h5>
            <p class="card-text">Генерация готовой к использованию микроразметки занимает секунды вместо минут ручного создания, что экономит время SEO-специалиста.</p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-eye text-primary me-2"></i>Предпросмотр</h5>
            <p class="card-text">Визуализация сниппетов помогает оценить, как микроразметка будет выглядеть в результатах поиска, перед добавлением на сайт.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Инициализация Socket.IO
  const socket = io();
  let sessionId = null;
  let startTime = null;
  let timerInterval = null;
  
  // Обновление таймера
  function updateTimer() {
    if (!startTime) return;
    
    const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('elapsedTime').textContent = `Прошло: ${elapsedTime} сек`;
  }
  
  // Обновление шагов генерации
  function updateSteps(step, status) {
    const steps = {
      1: 'step1',
      2: 'step2',
      3: 'step3',
      4: 'step4'
    };
    
    // Сбрасываем все шаги до текущего
    for (let i = 1; i <= 4; i++) {
      const stepEl = document.getElementById(steps[i]);
      const statusEl = stepEl.querySelector('.status-indicator');
      
      if (i < step) {
        statusEl.textContent = 'завершено';
        statusEl.className = 'status-indicator text-success';
        stepEl.classList.add('completed');
      } else if (i === step) {
        statusEl.textContent = status;
        statusEl.className = 'status-indicator text-primary';
        stepEl.classList.add('current');
      } else {
        statusEl.textContent = 'ожидание';
        statusEl.className = 'status-indicator';
        stepEl.classList.remove('completed', 'current');
      }
    }
  }
  
  // Обработчики событий Socket.IO
  socket.on('connect', () => {
    console.log('Connected to server');
  });
  
  socket.on('generation_status', (data) => {
    if (data.session_id !== sessionId) return;
    
    console.log('Generation status:', data);
    
    // Обновляем интерфейс в зависимости от статуса
    const statusBadge = document.getElementById('statusBadge');
    const statusMessage = document.getElementById('statusMessage');
    const progressBar = document.getElementById('progressBar');
    
    // Обновляем сообщение
    statusMessage.textContent = data.message;
    
    // Обновляем прогресс и статус
    switch(data.status) {
      case 'started':
        statusBadge.textContent = 'Анализ';
        statusBadge.className = 'badge bg-info';
        progressBar.style.width = '25%';
        progressBar.setAttribute('aria-valuenow', 25);
        updateSteps(1, 'выполняется');
        break;
      case 'processing':
        statusBadge.textContent = 'Извлечение данных';
        statusBadge.className = 'badge bg-primary';
        progressBar.style.width = '50%';
        progressBar.setAttribute('aria-valuenow', 50);
        updateSteps(2, 'выполняется');
        
        // Через 2 секунды обновляем до следующего шага
        setTimeout(() => {
          progressBar.style.width = '75%';
          progressBar.setAttribute('aria-valuenow', 75);
          updateSteps(3, 'выполняется');
          statusMessage.textContent = 'Создание микроразметки на основе данных с сайта...';
        }, 2000);
        break;
      case 'completed':
        statusBadge.textContent = 'Завершено';
        statusBadge.className = 'badge bg-success';
        progressBar.style.width = '100%';
        progressBar.setAttribute('aria-valuenow', 100);
        progressBar.classList.remove('progress-bar-animated');
        updateSteps(4, 'завершено');
        break;
      case 'error':
        statusBadge.textContent = 'Ошибка';
        statusBadge.className = 'badge bg-danger';
        progressBar.style.width = '100%';
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-danger');
        progressBar.setAttribute('aria-valuenow', 100);
        break;
    }
  });
  
  socket.on('generation_result', (data) => {
    if (data.session_id !== sessionId) return;
    
    console.log('Generation result:', data);
    
    // Останавливаем таймер
    if (timerInterval) {
      clearInterval(timerInterval);
    }
    
    // Скрываем спиннер и блок статуса
    document.getElementById('spinner').style.display = 'none';
    document.getElementById('statusContainer').style.display = 'none';
    
    // Показываем результат
    document.getElementById('resultBlock').textContent = data.result;
    document.getElementById('resultContainer').style.display = 'block';
    
    // Обновляем предпросмотр сниппета
    updateSingleSnippetPreview(data.result, data.domain);
    
    // Разблокируем кнопку
    document.getElementById('generateBtn').disabled = false;
  });
  
  socket.on('generation_error', (data) => {
    if (data.session_id !== sessionId) return;
    
    console.log('Generation error:', data);
    
    // Останавливаем таймер
    if (timerInterval) {
      clearInterval(timerInterval);
    }
    
    // Скрываем спиннер и блок статуса
    document.getElementById('spinner').style.display = 'none';
    document.getElementById('statusContainer').style.display = 'none';
    
    // Показываем ошибку
    const errorBlock = document.getElementById('errorBlock');
    errorBlock.textContent = `Ошибка при генерации микроразметки: ${data.error}`;
    errorBlock.style.display = 'block';
    
    // Разблокируем кнопку
    document.getElementById('generateBtn').disabled = false;
  });
  
  // Обработка событий для генерации всех шаблонов
  socket.on('generation_progress', (data) => {
    // Обновляем прогресс
    const progressBar = document.getElementById('allProgressBar');
    const completedCount = document.getElementById('completedCount');
    const currentTask = document.getElementById('currentTask');
    const completedList = document.getElementById('completedList');
    
    // Рассчитываем процент выполнения
    const percent = Math.floor((data.progress / data.total) * 100);
    
    // Обновляем прогресс-бар
    progressBar.style.width = `${percent}%`;
    progressBar.setAttribute('aria-valuenow', percent);
    
    // Обновляем счетчик
    completedCount.textContent = data.progress;
    
    // Обновляем текущую задачу
    currentTask.textContent = `Генерация: ${data.current}`;
    
    // Добавляем завершенную задачу в список
    if (data.completed && data.completed.length > 0) {
      const lastCompleted = data.completed[data.completed.length - 1];
      const listItem = document.createElement('li');
      listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
      listItem.innerHTML = `
        ${lastCompleted} 
        <span class="badge bg-success"><i class="bi bi-check"></i></span>
      `;
      completedList.appendChild(listItem);
    }
  });
  
  socket.on('all_generation_result', (data) => {
    // Перенаправляем на страницу с результатами
    window.location.href = `/get-results/${data.session_id}`;
  });
  
  // Отправка формы через AJAX
  document.getElementById('templateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Очищаем предыдущие результаты
    document.getElementById('errorBlock').style.display = 'none';
    document.getElementById('resultContainer').style.display = 'none';
    
    // Показываем блоки статуса
    document.getElementById('statusContainer').style.display = 'block';
    document.getElementById('spinner').style.display = 'block';
    
    // Сбрасываем индикаторы статуса
    document.getElementById('statusBadge').textContent = 'Ожидание';
    document.getElementById('statusBadge').className = 'badge bg-secondary';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').setAttribute('aria-valuenow', 0);
    document.getElementById('progressBar').classList.add('progress-bar-animated');
    document.getElementById('progressBar').classList.remove('bg-danger');
    
    // Сбрасываем шаги
    updateSteps(1, 'ожидание');
    
    const element_type = document.getElementById('element_type').value;
    const url = document.getElementById('url').value;
    
    // Проверка URL
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      document.getElementById('errorBlock').textContent = 'URL должен начинаться с http:// или https://';
      document.getElementById('errorBlock').style.display = 'block';
      document.getElementById('statusContainer').style.display = 'none';
      document.getElementById('spinner').style.display = 'none';
      return;
    }
    
    // Запускаем таймер
    startTime = Date.now();
    if (timerInterval) {
      clearInterval(timerInterval);
    }
    timerInterval = setInterval(updateTimer, 1000);
    
    // Отключаем кнопку на время запроса
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.disabled = true;
    
    fetch('/generate-template', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({element_type, url})
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        // Показываем ошибку
        document.getElementById('errorBlock').textContent = data.error;
        document.getElementById('errorBlock').style.display = 'block';
        document.getElementById('statusContainer').style.display = 'none';
        document.getElementById('spinner').style.display = 'none';
        generateBtn.disabled = false;
      } else {
        // Сохраняем ID сессии для отслеживания событий
        sessionId = data.session_id;
        console.log('Session ID:', sessionId);
      }
    })
    .catch(error => {
      console.error('Ошибка:', error);
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('statusContainer').style.display = 'none';
      document.getElementById('errorBlock').textContent = 'Произошла ошибка при обработке запроса';
      document.getElementById('errorBlock').style.display = 'block';
      generateBtn.disabled = false;
    });
  });

  // Кнопка копирования результата
  document.getElementById('copyBtn').addEventListener('click', function() {
    const resultText = document.getElementById('resultBlock').textContent;
    navigator.clipboard.writeText(resultText).then(() => {
      this.innerHTML = '<i class="bi bi-check2"></i> Скопировано!';
      setTimeout(() => { 
        this.innerHTML = '<i class="bi bi-clipboard"></i> Копировать';
      }, 2000);
    }).catch(err => {
      console.error('Ошибка копирования: ', err);
      this.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Ошибка';
      setTimeout(() => { 
        this.innerHTML = '<i class="bi bi-clipboard"></i> Копировать';
      }, 2000);
    });
  });
  
  // Инициализация формы для генерации всех шаблонов
  const allSchemaForm = document.querySelector('#all-schemas form');
  allSchemaForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const url = document.getElementById('allUrl').value;
    
    // Проверка URL
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
      alert('URL должен начинаться с http:// или https://');
      return;
    }
    
    // Показываем блок прогресса
    document.getElementById('allProgressCard').style.display = 'block';
    
    // Отключаем кнопку
    const generateBtn = document.querySelector('.btn-generate-all');
    generateBtn.disabled = true;
    
    // Очищаем список завершенных задач
    document.getElementById('completedList').innerHTML = '';
    document.getElementById('completedCount').textContent = '0';
    
    fetch('/generate-all', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({url})
    })
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
        generateBtn.disabled = false;
        document.getElementById('allProgressCard').style.display = 'none';
      } else {
        sessionId = data.session_id;
        console.log('Session ID for all templates:', sessionId);
      }
    })
    .catch(error => {
      console.error('Ошибка:', error);
      alert('Произошла ошибка при обработке запроса');
      generateBtn.disabled = false;
      document.getElementById('allProgressCard').style.display = 'none';
    });
  });

  // Функция для обновления предпросмотра сниппета при единичной генерации
  function updateSingleSnippetPreview(jsonLdCode, serverDomain) {
    const snippetContainer = document.getElementById('singleSnippet');
    if (!snippetContainer) return;
    
    try {
      // Извлекаем JSON-LD из кода
      const jsonMatch = jsonLdCode.match(/<script type="application\/ld\+json">([\s\S]*?)<\/script>/);
      
      if (jsonMatch && jsonMatch[1]) {
        const jsonData = JSON.parse(jsonMatch[1].trim());
        const type = jsonData['@type'];
        
        // Проверяем, является ли этот тип тем, что не отображается в сниппете
        const nonVisibleTypes = ['Organization', 'WebSite', 'ImageObject'];
        if (nonVisibleTypes.includes(type)) {
          snippetContainer.innerHTML = `
            <div class="google-snippet text-center">
              <div class="py-3">
                <i class="bi bi-info-circle text-muted me-2"></i>
                <span class="text-muted">Этот тип микроразметки не влияет на отображение в поисковой выдаче</span>
              </div>
            </div>
          `;
          return;
        }
        
        // Получаем доменное имя из URL, введенного пользователем или переданного сервером
        let domain = serverDomain || '';
        
        // Если домен не был передан с сервера, пытаемся получить его из других источников
        if (!domain) {
          const urlInput = document.getElementById('url').value;
          try {
            if (urlInput) {
              const urlObj = new URL(urlInput);
              domain = urlObj.hostname;
            } else if (jsonData.url) {
              const urlObj = new URL(jsonData.url);
              domain = urlObj.hostname;
            } else {
              domain = 'example.com';
            }
          } catch (e) {
            domain = 'example.com';
          }
        }
        
        // В зависимости от типа микроразметки создаем соответствующий предпросмотр
        switch (type) {
          case 'LocalBusiness':
            createLocalBusinessSnippet(snippetContainer, jsonData, domain);
            break;
          case 'Product':
            createProductSnippet(snippetContainer, jsonData, domain);
            break;
          case 'CollectionPage':
            createCollectionSnippet(snippetContainer, jsonData, domain);
            break;
          case 'FAQPage':
            createFAQSnippet(snippetContainer, jsonData, domain);
            break;
          case 'QAPage':
            createQASnippet(snippetContainer, jsonData, domain);
            break;
          case 'BreadcrumbList':
            createBreadcrumbsSnippet(snippetContainer, jsonData, domain);
            break;
          default:
            createDefaultSnippet(snippetContainer, jsonData, domain);
        }
      } else {
        // Если не удалось найти JSON-LD
        snippetContainer.innerHTML = `
          <div class="google-snippet-placeholder text-center py-3">
            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
            <span class="text-muted">Не удалось распарсить микроразметку для предпросмотра</span>
          </div>
        `;
      }
    } catch (e) {
      console.warn('Не удалось распарсить микроразметку:', e);
      snippetContainer.innerHTML = `
        <div class="google-snippet-placeholder text-center py-3">
          <i class="bi bi-exclamation-triangle text-warning me-2"></i>
          <span class="text-muted">Ошибка при создании предпросмотра: ${e.message}</span>
        </div>
      `;
    }
  }
  
  // Вспомогательные функции для создания предпросмотров разных типов
  function createLocalBusinessSnippet(container, data, domain) {
    const address = data.address ? 
      [data.address.addressLocality, data.address.streetAddress].filter(Boolean).join(', ') : 
      'Москва, ул. Примерная, 123';
    
    const phone = data.telephone || '+7 (XXX) XXX-XX-XX';
    const hours = data.openingHours || 'Пн-Пт: 9:00-18:00';
    
    container.innerHTML = `
      <div class="google-snippet">
        <div class="snippet-title text-primary fw-bold">${domain} - Контактная информация</div>
        <div class="snippet-url text-success small mb-1">${data.url || 'https://' + domain}</div>
        <div class="snippet-description text-dark small">
          <div><i class="bi bi-geo-alt text-secondary me-1"></i> Адрес: <span class="snippet-address">${address}</span></div>
          <div><i class="bi bi-telephone text-secondary me-1"></i> Телефон: <span class="snippet-phone">${phone}</span></div>
          <div><i class="bi bi-clock text-secondary me-1"></i> Часы работы: <span class="snippet-hours">${hours}</span></div>
        </div>
      </div>
    `;
  }
  
  function createProductSnippet(container, data, domain) {
    let price = '15 990';
    let currency = '₽';
    
    if (data.offers) {
      if (data.offers.price) {
        price = formatPrice(data.offers.price);
        currency = data.offers.priceCurrency === 'RUB' ? '₽' : (data.offers.priceCurrency || '₽');
      }
    }
    
    container.innerHTML = `
      <div class="google-snippet">
        <div class="snippet-title text-primary fw-bold">${data.name || 'Название товара'} - ${domain}</div>
        <div class="snippet-url text-success small mb-1">${data.url || 'https://' + domain}</div>
        <div class="snippet-description text-dark small">
          <div class="d-flex align-items-center mb-1">
            <div class="snippet-rating">
              <span class="text-warning">★★★★★</span>
            </div>
            <span class="snippet-reviews ms-1">(123 отзыва)</span>
            <span class="snippet-price ms-2 fw-bold">${price} ${currency}</span>
          </div>
          <div>В наличии · Быстрая доставка</div>
        </div>
      </div>
    `;
  }
  
  function createCollectionSnippet(container, data, domain) {
    let lowPrice = '5 000';
    let highPrice = '150 000';
    let currency = '₽';
    
    if (data.mainEntity && data.mainEntity.offers) {
      const offers = data.mainEntity.offers;
      if (offers.lowPrice && offers.highPrice) {
        lowPrice = formatPrice(offers.lowPrice);
        highPrice = formatPrice(offers.highPrice);
        currency = offers.priceCurrency === 'RUB' ? '₽' : (offers.priceCurrency || '₽');
      }
    }
    
    container.innerHTML = `
      <div class="google-snippet">
        <div class="snippet-title text-primary fw-bold">${data.name || 'Каталог товаров'} - ${domain}</div>
        <div class="snippet-url text-success small mb-1">${data.url || 'https://' + domain}</div>
        <div class="snippet-description text-dark small">
          <div class="d-flex align-items-center mb-1">
            <div class="snippet-rating">
              <span class="text-warning">★★★★★</span>
            </div>
            <span class="snippet-reviews ms-1">(324 отзыва)</span>
          </div>
          <div>Цены: <span class="fw-bold">от ${lowPrice}${currency} до ${highPrice}${currency}</span> · 125 товаров</div>
        </div>
      </div>
    `;
  }
  
  function createFAQSnippet(container, data, domain) {
    let faqItems = '';
    
    if (data.mainEntity && Array.isArray(data.mainEntity)) {
      // Берем первые 2 вопроса для предпросмотра
      const questions = data.mainEntity.slice(0, 2);
      
      faqItems = questions.map((q, index) => {
        const answer = q.acceptedAnswer.text.length > 60 
          ? q.acceptedAnswer.text.substring(0, 60) + '...' 
          : q.acceptedAnswer.text;
          
        return `
          <div class="faq-item${index < questions.length - 1 ? ' mb-2' : ''}">
            <div class="fw-bold">${q.name}</div>
            <div>${answer}</div>
          </div>
        `;
      }).join('');
    } else {
      faqItems = `
        <div class="faq-item mb-2">
          <div class="fw-bold">Как сделать заказ?</div>
          <div>Для оформления заказа добавьте товары в корзину и следуйте...</div>
        </div>
        <div class="faq-item">
          <div class="fw-bold">Какие способы доставки вы предлагаете?</div>
          <div>Мы предлагаем курьерскую доставку, самовывоз из наших...</div>
        </div>
      `;
    }
    
    container.innerHTML = `
      <div class="google-snippet">
        <div class="snippet-title text-primary fw-bold">Часто задаваемые вопросы - ${domain}</div>
        <div class="snippet-url text-success small mb-1">${data.url || 'https://' + domain}</div>
        <div class="snippet-description text-dark small">
          <div class="snippet-faq">
            ${faqItems}
          </div>
        </div>
      </div>
    `;
  }
  
  function createQASnippet(container, data, domain) {
    let questionName = 'Товары';
    let answerText = '⭐ Высокое качество товаров 💎 Доставка по всей России 💎 Выгодная бонусная система';
    let upvoteCount = 26;
    let answerCount = 1;
    
    if (data.mainEntity) {
      if (data.mainEntity.name) {
        questionName = data.mainEntity.name;
      }
      
      if (data.mainEntity.acceptedAnswer && data.mainEntity.acceptedAnswer.text) {
        answerText = data.mainEntity.acceptedAnswer.text;
      }
      
      if (data.mainEntity.upvoteCount) {
        upvoteCount = data.mainEntity.upvoteCount;
      } else if (data.mainEntity.acceptedAnswer && data.mainEntity.acceptedAnswer.upvoteCount) {
        upvoteCount = data.mainEntity.acceptedAnswer.upvoteCount;
      }
      
      if (data.mainEntity.answerCount) {
        answerCount = data.mainEntity.answerCount;
      }
    }
    
    container.innerHTML = `
      <div class="google-snippet">
        <div class="snippet-title text-primary fw-bold">${domain} - Вопросы и ответы</div>
        <div class="snippet-url text-success small mb-1">${data.url || 'https://' + domain}</div>
        <div class="snippet-description text-dark small">
          <div class="fw-bold mb-1">${questionName}</div>
          <div class="mb-1">${answerText}</div>
          <div class="text-secondary small">
            <span>${upvoteCount} человек нашли ответ полезным</span>
            <span class="ms-3">Ответов: ${answerCount}</span>
          </div>
        </div>
      </div>
    `;
  }
  
  function createBreadcrumbsSnippet(container, data, domain) {
    let breadcrumbs = 'Главная > Каталог > 📦📦📦 Категория товаров > Подкатегория';
    
    if (data.itemListElement && Array.isArray(data.itemListElement)) {
      breadcrumbs = data.itemListElement.map(item => item.name).join(' > ');
    }
    
    container.innerHTML = `
      <div class="google-snippet">
        <div class="snippet-title text-primary fw-bold">Название страницы - ${domain}</div>
        <div class="snippet-url text-success small mb-1">${data.url || 'https://' + domain}</div>
        <div class="snippet-description text-dark small">
          <div class="breadcrumbs small text-secondary">
            ${breadcrumbs}
          </div>
          <div>Описание страницы с хлебными крошками.</div>
        </div>
      </div>
    `;
  }
  
  function createDefaultSnippet(container, data, domain) {
    container.innerHTML = `
      <div class="google-snippet">
        <div class="snippet-title text-primary fw-bold">${data.name || domain}</div>
        <div class="snippet-url text-success small mb-1">${data.url || 'https://' + domain}</div>
        <div class="snippet-description text-dark small">
          ${data.description || 'Описание не найдено в микроразметке'}
        </div>
      </div>
    `;
  }
  
  // Вспомогательная функция для форматирования цены
  function formatPrice(price) {
    // Форматируем число без валюты, убираем возможные пробелы в конце
    return parseFloat(price).toLocaleString('ru-RU').trim();
  }
</script>
</body>
</html>